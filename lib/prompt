#!/bin/bash

__IS_ROOT="";
__IS_SSH="";

__IS_GIT="";
git_status="";
git_branch="";
github="";

__prompt() {
  ## Highlight the user name when logged in as root.
  if [[ $USER = "root" ]]; then
    __IS_ROOT="1";
  fi
  export __IS_ROOT;

  ## Highlight the hostname when connected via SSH.
  if [[ $SSH_TTY ]]; then
    __IS_SSH="1";
  fi
  export __IS_SSH;

  __update_prompt;
}

__update_github() {
  __IS_GIT="";
  git_branch="";
  git_status="";

  if [[ `git rev-parse --is-inside-work-tree &> /dev/null; echo "$?"` = "0" ]]; then
    __IS_GIT="1";

    if [[ `git rev-parse --is-inside-git-dir 2> /dev/null` = "false" ]]; then

      ## Check for uncommitted files
      if [[ -n `git diff --quiet --ignore-submodules --cached` ]]; then
        git_status+="+";
      fi

      ## Check for unstaged files
      if [[ -n `git diff-files --quiet --ignore-submodules --` ]]; then
        git_status+="!";
      fi

      ## Check for untracked files
      if [[ -n `git ls-files --others --exclude-standard` ]]; then
        git_status+="?";
      fi
    fi
  fi
}

__update_prompt() {
  __update_github;

  ## Set user style
  user_style="${magenta}${b}";
  [[ $__IS_ROOT = "1" ]] && user_style="${red}${b}";
  ## Set host style
  host_style="${blue}${b}";
  [[ $__IS_SSH = "1" ]] && host_style="${yellow}${b}";

  user="${user_style}\u${re}";
  host=" at ${host_style}\h${re}";
  dir=" in ${green}${b}[\w]${re}";
  github="";
  if [[ $__IS_GIT = "1" ]]; then
    github=" ${git_branch} ${git_status}";
  fi

  PS1="${user}${host}${dir}${github}";
  PS1+="\n";
  PS1+="$ ";
  export PS1;

  PS2="-> ";
  export PS2;
}

PROMPT_COMMAND="__prompt; history -a";
export PROMPT_COMMAND;
